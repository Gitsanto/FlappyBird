<!--
  Copyright (c) 2017-present, Facebook, Inc.
  All rights reserved.

  This source code is licensed under the license found in the
  LICENSE file in the root directory of this source tree.
-->

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="full-screen" content="yes"/>
  <meta name="screen-orientation" content="portrait"/>
  <meta name="viewport" content="user-scalable=no"/>
  <link href="css/style.css" rel="stylesheet" type="text/css"/>
</head>

<body>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!-- build:js -->
  <script src="https://www.facebook.com/assets.php/en_US/fbinstant.latest.js"></script>
  <!-- endbuild -->
  <!-- Phaser.js -->
  <script src="lib/phaser-facebook-instant-games.js"></script>
  <script src="./Object/Button.js"></script>
  <script src="./Object/Model.js"></script>
  <script type="text/javascript">

    const assets = [
      'img/mock/friend1.png',
      'img/asset2.png',
      'img/asset3.png',
      'img/asset4.png'
    ];

     let style = { font: '20px Arial', fill: '#fff' };

     var game;

    //Initialize the phaser
    var config = {
        type: Phaser.AUTO,
        width: 600,
        height: 500,
        scale: 'SHOW_ALL',
        physics: { default: 'arcade' }, // The physics engine to use
        scene:{
            preload: preload,
            create: create,
            update: update
        }
         };
         

    window.onload = function() {
      $('#info-section').hide();

      // When the window loads, start to initialize the SDK
      FBInstant.initializeAsync().then(function() {

        // We can start to load assets
        for (let i in assets) {
          // When preloading assets, make sure to report the progress
          FBInstant.setLoadingProgress(i / assets.length * 100);
        }
  
        // Now that assets are loaded, call startGameAsync
        FBInstant.startGameAsync().then(onStart);
      });
    };
    
    function onStart() {
      // This is called when the user has tapped Play
      // Information from the SDK can now be accessed
    //   $('#photo').attr('src', FBInstant.player.getPhoto());
    //   $('#player-name').html(FBInstant.player.getName());
    //   $('#player-id').html(FBInstant.player.getID());
    //   $('#context-type').html(FBInstant.context.getType());
      try{
        $('#entrypointdata').html(JSON.stringify(FBInstant.getEntryPointData()));
      }catch(e){
        console.log(e);
      }
    //  $('#info-section').show();
    // }
    game = new Phaser.Game(config);
    }

    function preload ()
    {
  

        // display progress bar
        var progressBar = this.add.graphics();
        var progressBox = this.add.graphics();
        progressBox.fillStyle(0x222222, 0.8);
        progressBox.fillRect(240, 270, 320, 50);

        var width = this.cameras.main.width;
        var height = this.cameras.main.height;
        var loadingText = this.make.text({
        x: width / 2,
        y: height / 2 - 50,
        text: 'Loading...',
        style: {
        font: '20px monospace',
        fill: '#ffffff'
        }
        });
        loadingText.setOrigin(0.5, 0.5);

        var percentText = this.make.text({
                    x: width / 2,
                    y: height / 2 - 5,
                    text: '0%',
                    style: {
                    font: '18px monospace',
                    fill: '#ffffff'
                    }
        });
        percentText.setOrigin(0.5, 0.5);

        var assetText = this.make.text({
        x: width / 2,
        y: height / 2 + 50,
        text: '',
        style: {
        font: '18px monospace',
        fill: '#ffffff'
        }
        });

        assetText.setOrigin(0.5, 0.5);

        // update progress bar
        this.load.on('progress', function (value) {
                percentText.setText(parseInt(value * 100) + '%');
                progressBar.clear();
                progressBar.fillStyle(0xffffff, 1);
                progressBar.fillRect(250, 280, 300 * value, 30);
        });

        // update file progress text
        this.load.on('fileprogress', function (file) {
                assetText.setText('Loading asset: ' + file.key);
        });

        // remove progress bar when complete
        this.load.on('complete', function () {
                progressBar.destroy();
                progressBox.destroy();
                loadingText.destroy();
                percentText.destroy();
                assetText.destroy();
                }.bind(this));

        this.timedEvent = this.time.delayedCall(3000, this.ready, [], this);

        // load assets needed in our game
        this.load.image('blueButton1', 'img/mock/ui/blue_button02.png');
        this.load.image('blueButton2', 'img/mock/ui/blue_button03.png');
        this.load.image('phaserLogo', 'img/mock/nevBot.png');
        this.load.image('box', 'img/mock/ui/grey_box.png');
        this.load.image('checkedBox', 'img/mock/ui/blue_boxCheckmark.png');
        this.load.audio('bgMusic', ['img/mock/TownTheme.mp3']);

        this.load.image('logo', assets[0]);
        // this.facebook.once('startgame', this.startGame, this);
        // add logo image
        // this.add.image(300, 200, 'logo');

        this.load.image('player', 'img/mock/ui/bird.png');
        this.load.image('coin', 'img/mock/ui/coin.png');
        this.load.image('background', 'img/mock/ui/bg.png');
        this.load.image('pipe', 'img/mock/ui/pipe.png');

        }
        

    function create ()
    {
            // Game
        this.gameButton = new Button(this, config.width/2, config.height/2 - 100, 'blueButton1', 'blueButton2', 'Play', 'Game');

        // Options
        this.optionsButton = new Button(this, config.width/2, config.height/2, 'blueButton1', 'blueButton2', 'Options', 'Options');

        // Credits
        this.creditsButton = new Button(this, config.width/2, config.height/2 + 100, 'blueButton1', 'blueButton2', 'Credits', 'Credits');
        
        // need to create class with scene relationship    
        this.gmodel =  new  Model(this,true,true,false);

        if (this.gmodel.musicOn === true && this.gmodel.bgMusicPlaying === false) {
            this.bgMusic = this.sound.add('bgMusic', { volume: 0.5, loop: true });
            this.bgMusic.play();
            this.gmodel.bgMusicPlaying = true;
            this.gmodel.bgMusic = this.bgMusic;
        }

        //background
    // first create first index
    this.background = this.add
      .tileSprite(0, 0, config.width,config.height, "background")
      .setDepth(0)
      .setOrigin(0, 0);

      
    // Parameters: x position, y position, name of the sprite
    this.player = this.physics.add.sprite(100, 100, 'player');

    this.player.body.gravity.y = 1000;
    this.player.body.velocity.x = 10;
    this.player.body.setAllowGravity(true);

    
    // Store the score in a variable, initialized at 0
    this.score = 0;

    // The style of the text 
    // A lot of options are available, these are the most important ones
    // let style = { font: '20px Arial', fill: '#fff' };

    // Display the score in the top left corner
    // Parameters: x position, y position, text, style
    this.scoreText = this.add.text(20, 20, 'score: ' + this.score, style)
                      .setDepth(1);

    //move player
    this.arrow = this.input.keyboard.createCursorKeys();
    this.jump = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.UP);

    //pipe
    this.pipes = this.add.group();

    // Timer that create or spawn pipe
    // this.addPipeColumn();

    this.time.addEvent({
      delay: 3000,
      callback: this.addPipeColumn,
      callbackScope: this,
      loop: true
    });

    function centerButton (gameObject, offset = 0) {
        Phaser.Display.Align.In.Center(
        gameObject,
        this.add.zone(config.width/2, config.height/2 - offset * 100, config.width, config.height)
        );
    }


    function centerButtonText (gameText, gameButton) {
        Phaser.Display.Align.In.Center(
        gameText,
        gameButton
        );
    }


    // this.addPipeColumn();

    }
    
  

    function update ()
    {
        
        // this.scene.start('Preloader');
    if (this.physics.overlap(this.player, this.coin)) {
      this.hit();
    }

    if (this.physics.overlap(this.player, this.pipes)) {
      this.playerDie();
    }

    if (this.arrow.right.isDown) {
      this.player.x += 3;
    } else if (this.arrow.left.isDown) {
      this.player.x -= 3;
    } 

    if (this.arrow.down.isDown) {
      this.player.y += 3;
    } else if (this.arrow.up.isDown) {
      this.player.y -= 3;
    } 
    // jump
    if (this.jump.isDown) {
      jumpPlayer();
    }
    // restart game if player go below the ground
    if (this.player.y > this.sys.canvas.height) {
      this.scene.restart();
    }
    if (this.player.x > this.pipes.x) {
      console.log('pass pipe');
    }

    function jumpPlayer() {
        this.player.body.velocity.y = -250;
  }

  function playerDie(){
    console.log('Die');
    // this.scene.pause();
    this.scene.start('Result',{ score: this.score });
  }

   function addPipe(x, y) {
    const pipe = this.physics.add.image(x, y, 'pipe') 
          pipe.body.velocity.x = -200;
          pipe.body.setAllowGravity(false)
          pipe.checkWorldBounds = true;
          pipe.outOfBoundsKill = true;
   this.pipes.add(pipe);
  }



  function addPipeColumn() {
     // randomly pick a number between 1 and 5
     let hole = Math.floor(Math.random() * 5) + 1;
     let pipeX = config.width;

     // add 6 pipes with one big hole at position hole and hole + 1
     for (let i = 0; i < 10; i++) {
       if (i !== hole && i !== hole + 1 && i !== hole + 2) {
         if (i === hole - 1) {
           this.addPipe(pipeX, i * 60, 0);
         } else if (i === hole + 3) {
           this.addPipe(pipeX, i * 60, 1);
         } else {
           this.addPipe(pipeX, i * 60, 2);
         }
       }
     }
     this.score += 10;
     this.scoreText.setText('score: ' + this.score);  
    } 

  }





  </script>

  <header>
    <h1>Instant Games Demos</h1>
    <h2>TestGameDemo!</h2>
  </header>

  <section id="info-section">
    <p>If you can see this, then FBInstant initialized properly and the game has started!</p>

    <img id="photo" class="profile_picture"/>

    <table>
      <tr>
        <th>Player Name</th>
        <td id="player-name"></td>
      </tr>
      <tr>
        <th>Player ID</th>
        <td id="player-id"></td>
      </tr>
      <tr>
        <th>Context Type</th>
        <td id="context-type"></td>
      </tr>
      <tr>
        <th>Entrypoint Data</th>
        <td id="entrypointdata"></td>
      </tr>
    </table>
  </section>
</body>
</html>
